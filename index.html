<!DOCTYPE html>
<html>
    <head>
        <meta charset=utf-8>
        <title>Memory Leak Example</title>
        <style>
            body { margin: 0; }
            canvas { width: 100%; height: 100% }
        </style>
    </head>
    <body>
        <script src="./three.js"></script>
        <script>
            var renderer = new THREE.WebGLRenderer();

            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 1);

            document.body.appendChild( renderer.domElement );

            var camera = new THREE.PerspectiveCamera( 30, window.innerWidth / window.innerHeight, 1, 1000 );

            camera.position.x = 0;
            camera.position.y = 0;
            camera.position.z = 500;

            var scene = new THREE.Scene();

            let imageSize = 100;
            let meshArray = [];
            let frameCount = 0;

            function animate() {
                requestAnimationFrame( animate );
                renderer.render( scene, camera );
                frameCount += 1;
                if(!(frameCount%60)){
                  console.log("Creating Image!");
                  renderImage();
                }
                if(!((frameCount%60)-30) && frameCount > 60){
                  console.log("Removing Image!");
                  disposeImage();
                }
            }

            animate();

            function disposeImage() {
                garbageCollection(meshArray[0]);
                meshArray.splice(0,1);
            }

            function garbageCollection(mesh) {
                scene.remove(mesh);
                mesh.geometry.dispose();
                mesh.geometry = undefined;
                mesh.material.map.dispose();
                mesh.material.map = undefined;
                mesh.material.dispose();
                mesh.material = undefined;
                mesh = undefined;
            }

            function renderImage() {
                let loader = new THREE.TextureLoader();
                loader.crossOrigin = "Anonymous";

                loader.load( 'environment-logo.jpg', function ( texture ) {
                    let material = new THREE.MeshBasicMaterial( { map: texture, overdraw: 0.5 } );
                    let geometry = new THREE.PlaneGeometry(imageSize, imageSize, 1, 1);
                    let mesh = new THREE.Mesh(geometry,material);
                    mesh.geometry.computeBoundingBox();
                    mesh.position.set(0,0,10);
                    mesh.scale.set(1, 1, 1);
                    scene.add(mesh);
                    meshArray.push(mesh);
                });
            }
        </script>
    </body>
</html>
